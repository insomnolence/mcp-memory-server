# MCP Memory Server - Architecture Overview

## 🏗️ System Architecture

The MCP Memory Server implements a **hierarchical memory system** with **domain-specific configuration**, designed for intelligent content management and retrieval.

```
┌─────────────────────────────────────────────────────────┐
│                  MCP Memory Server                      │
├─────────────────────────────────────────────────────────┤
│                   FastAPI Server                       │
│              (JSON-RPC Protocol)                       │
├─────────────────────────────────────────────────────────┤
│                    Tool Registry                       │
│  ┌─────────────┬────────────┬─────────────────────────┐  │
│  │   Document  │   Query    │     Lifecycle/Stats     │  │
│  │    Tools    │   Tools    │        Tools            │  │
│  └─────────────┴────────────┴─────────────────────────┘  │
├─────────────────────────────────────────────────────────┤
│              Hierarchical Memory System                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │                Memory Tiers                         │ │
│  │  ┌──────────┬──────────┬──────────┬─────────────┐   │ │
│  │  │Short-term│Long-term │Permanent │Consolidated │   │ │
│  │  │   (TTL)  │ (Important)│(Critical)│ (Summaries)│   │ │
│  │  └──────────┴──────────┴──────────┴─────────────┘   │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│             Importance Scoring Engine                  │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  Domain Patterns → Content Analysis → Score        │ │
│  │     (Keywords)        (Code/Error)      (0-1)       │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│             Lifecycle Management System                │
│  ┌─────────────────────────────────────────────────────┐ │
│  │     TTL Engine + Memory Aging + Maintenance        │ │
│  │   (Time decay)   (Score decay)   (Cleanup/Stats)   │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│              Vector Database Layer                     │
│  ┌─────────────────────────────────────────────────────┐ │
│  │          ChromaDB + HuggingFace Embeddings          │ │
│  │   Semantic Search + Cross-Encoder Reranking        │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 🧠 Memory Hierarchy

### 4-Tier Memory System

```
┌─────────────────────────────────────────────────────────┐
│                    Memory Tiers                        │
├─────────────────────────────────────────────────────────┤
│ 🔄 Short-term Memory                                   │
│    • Recent interactions                               │
│    • Auto-pruning (TTL: 5min - 1 week)               │
│    • Importance: 0.0 - 0.7                           │
├─────────────────────────────────────────────────────────┤
│ 💾 Long-term Memory                                    │
│    • Important persistent knowledge                    │
│    • TTL: 1 week + jitter                            │
│    • Importance: 0.7 - 0.95                          │
├─────────────────────────────────────────────────────────┤
│ 💎 Permanent Memory                                    │
│    • Critical knowledge (never expires)               │
│    • Importance: ≥ 0.95                               │
│    • User-flagged or auto-promoted                    │
├─────────────────────────────────────────────────────────┤
│ 📦 Consolidated Memory                                 │
│    • Compressed summaries of related content          │
│    • Reduces redundancy                               │
│    • Generated by clustering + summarization          │
└─────────────────────────────────────────────────────────┘
```

## ⚡ Content Flow

### Document Addition Flow
```
User Content
     ↓
┌─────────────────────────────────────────┐
│          Domain Scoring Engine          │
│  ┌─────────────────────────────────────┐ │
│  │  Domain Pattern Matching           │ │
│  │  (Keywords, Regex, Bonuses)        │ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │  Content Analysis                   │ │
│  │  (Code, Errors, Length, Language)  │ │
│  └─────────────────────────────────────┘ │
│  ┌─────────────────────────────────────┐ │
│  │  Context Evaluation                 │ │
│  │  (User flags, Solution markers)    │ │
│  └─────────────────────────────────────┘ │
│           ↓ Final Score (0-1)            │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│          Collection Routing            │
│  Score ≥ 0.95 → Permanent Memory       │
│  Score ≥ 0.70 → Long-term Memory       │
│  Score < 0.70 → Short-term Memory      │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│         Vector Database Storage         │
│  • Generate embeddings                  │
│  • Store with metadata                  │  
│  • Set TTL based on tier               │
└─────────────────────────────────────────┘
```

### Query Flow
```
User Query
     ↓
┌─────────────────────────────────────────┐
│          Multi-Collection Search        │
│  • Query all relevant collections      │
│  • Semantic similarity search          │
│  • Apply collection-specific filters   │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│          Dynamic Scoring               │
│  • Semantic similarity (40%)           │
│  • Recency factor (30%)               │
│  • Access frequency (20%)             │
│  • Importance score (10%)             │
└─────────────────────────────────────────┘
     ↓
┌─────────────────────────────────────────┐
│          Cross-Encoder Reranking       │
│  • Query-document pair scoring         │
│  • Improved relevance ranking          │
│  • Final result ordering              │
└─────────────────────────────────────────┘
     ↓
    Results
```

## 🎯 Universal Domain System

### Pattern Engine Architecture
```
┌─────────────────────────────────────────────────────────┐
│                Domain Configuration                     │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐ │
│  │                Pattern Definitions                  │ │
│  │  business-development.json                          │ │
│  │  ├─ revenue_opportunities: ["revenue", "profit"]   │ │
│  │  ├─ market_intelligence: ["competitor", "analysis"] │ │
│  │  └─ client_relationship: ["client", "partnership"] │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐ │
│  │              Pattern Matching Engine                │ │
│  │  • Keyword detection (case-insensitive)            │ │
│  │  • Regex pattern support                           │ │
│  │  • Match modes: any/all/weighted                   │ │
│  │  • Bonus score calculation                         │ │
│  └─────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐ │
│  │             Permanence Triggers                     │ │
│  │  • Auto-promotion keywords                         │ │
│  │  • Importance boost calculation                    │ │
│  │  • Critical content detection                      │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### Domain Examples
- **Software Development**: Code, bugs, architecture, APIs
- **Business Development**: Revenue, deals, KPIs, markets
- **Research**: Methodology, findings, evidence, hypotheses
- **Creative Writing**: Characters, plot, dialogue, themes
- **Cooking**: Recipes, techniques, ingredients, innovations
- **Personal**: Extensible for any personal use case

## ⏰ Lifecycle Management

### TTL (Time-To-Live) System
```
┌─────────────────────────────────────────────────────────┐
│                    TTL Tiers                           │
├─────────────────────────────────────────────────────────┤
│  High Frequency    │ 5 min ± 1 min   │ Rapid iterations│
│  Medium Frequency  │ 1 hr ± 10 min   │ Session data    │
│  Low Frequency     │ 1 day ± 2 hrs   │ Daily insights  │
│  Static           │ 1 week ± 1 day   │ Important data  │
│  Permanent        │ ∞ (never)        │ Critical data   │
└─────────────────────────────────────────────────────────┘
```

### Memory Aging Process
```
Document Creation
     ↓
Initial Importance Score
     ↓ (time passes)
┌─────────────────────────────────────────┐
│          Aging Calculation             │
│  new_score = original_score *           │
│    exp(-decay_rate * age_in_days)       │
└─────────────────────────────────────────┘
     ↓
Score Below Threshold?
     ↓ (yes)
TTL Expiration → Cleanup
     ↓ (no)
Remain in Memory
```

### Background Maintenance
```
┌─────────────────────────────────────────────────────────┐
│              Maintenance Scheduler                     │
├─────────────────────────────────────────────────────────┤
│  Every Hour     │ Cleanup expired documents             │
│  Every 6 Hours  │ Consolidate related memories          │
│  Every 24 Hours │ Generate system statistics            │
│  Every Week     │ Deep maintenance and optimization     │
└─────────────────────────────────────────────────────────┘
```

## 🔧 Configuration Architecture

### Separation of Concerns
```
┌─────────────────────────────────────────────────────────┐
│                 Domain Configs                         │
│              (WHAT you use it for)                     │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  • Content scoring patterns                        │ │
│  │  • Domain-specific keywords                        │ │
│  │  • Permanence triggers                             │ │
│  │  • Industry/use-case specific logic               │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           +
┌─────────────────────────────────────────────────────────┐
│              Environment Configs                       │
│              (WHERE you run it)                        │
│  ┌─────────────────────────────────────────────────────┐ │
│  │  • Database paths and settings                     │ │
│  │  • Server host/port configuration                 │ │
│  │  • Logging levels and outputs                     │ │
│  │  • Performance and resource settings              │ │
│  └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                 Merged Configuration                   │
│              (Runtime configuration)                   │
└─────────────────────────────────────────────────────────┘
```

## 🛠️ Component Interactions

### Tool Registry Pattern
```python
# Dependency injection for clean architecture
tool_registry = {
    "add_document": partial(add_document_tool, memory_system),
    "query_documents": partial(query_documents_tool, memory_system),
    "get_memory_stats": partial(get_memory_stats_tool, memory_system),
    # ... more tools
}
```

### Memory System Interface
```python
class HierarchicalMemorySystem:
    def __init__(self, db_config, embeddings_config, memory_config, scoring_config):
        self.short_term_memory = ChromaCollection("short_term")
        self.long_term_memory = ChromaCollection("long_term") 
        self.permanent_memory = ChromaCollection("permanent")
        self.consolidated_memory = ChromaCollection("consolidated")
        self.scorer = MemoryImportanceScorer(scoring_config)
        self.lifecycle_manager = LifecycleManager()
```

## 📊 Performance Characteristics

### Scalability Design
- **Horizontal Scaling**: Multiple server instances with different domains
- **Vertical Scaling**: Efficient memory management with TTL and consolidation
- **Data Partitioning**: Domain-specific databases and collections
- **Caching Strategy**: In-memory scoring cache and embedding cache

### Memory Efficiency
- **TTL-based Cleanup**: Automatic removal of outdated content
- **Consolidation**: Merge similar documents to reduce redundancy
- **Importance-based Retention**: Keep only valuable content long-term
- **Lazy Loading**: Load embeddings and models on demand

### Query Performance
- **Multi-factor Scoring**: Balanced relevance calculation
- **Cross-encoder Reranking**: Improved result quality
- **Collection Targeting**: Search only relevant memory tiers
- **Embedding Caching**: Reuse computed vectors

## 🔒 Security & Reliability

### Data Protection
- **Local Storage**: All data stored locally (no external dependencies)
- **Configuration Validation**: Prevent invalid configurations
- **Error Handling**: Graceful degradation on failures
- **Backup Support**: Easy data backup and restoration

### System Reliability
- **Fallback Defaults**: System works without configuration
- **Data Migration**: Smooth transitions between system versions
- **Health Monitoring**: Built-in statistics and health checks
- **Logging**: Comprehensive logging for debugging and monitoring

The architecture is designed for **flexibility**, **performance**, and **ease of use** while maintaining **professional standards** and **scalability**.